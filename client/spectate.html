<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spectator View</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h1>Live Race Results</h1>
  <div id="results">Loading…</div>
  <script>
    // Format ms -> hh:mm:ss
    function formatDuration(ms) {
      const t = Math.floor(ms / 1000);
      const h = String(Math.floor(t / 3600)).padStart(2, '0');
      const m = String(Math.floor((t % 3600) / 60)).padStart(2, '0');
      const s = String(t % 60).padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    // Find sessionId from URL (?sessionId=xxx) or localStorage
    function getSessionId() {
      const p = new URLSearchParams(window.location.search);
      return p.get('sessionId') ||
             localStorage.getItem('currentResultsSession') ||
             localStorage.getItem('sessionId');
    }

    async function fetchResults() {
      const sessionId = getSessionId();
      const box = document.getElementById('results');

      if (!sessionId) {
        box.textContent = 'No race in progress.';
        return;
      }

      try {
        const res = await fetch(`/results?sessionId=${sessionId}`);
        if (!res.ok) throw new Error('Server error');
        const data = await res.json();

        box.innerHTML = '';                     // clear old list
        if (!Array.isArray(data) || data.length === 0) {
          box.textContent = 'No finishers yet.';
          return;
        }

        // Create an element for each finisher
        data.forEach(r => {
          const p = document.createElement('p');
          p.className = 'runner';
          p.textContent = `Runner ${r.runnerId} – ${formatDuration(r.finish_time)}`;
          box.appendChild(p);
        });
      } catch (err) {
        box.textContent = 'Error loading results.';
        console.error(err);
      }
    }

    fetchResults(); // initial load
    setInterval(fetchResults, 15000); // refresh every 15 s
  </script>
</body>
</html>
